# State Machine


``` mermaid
stateDiagram-v2
    classDef red fill:#f00,color:white,font-weight:bold
    classDef blue fill:#00ff,color:white,font-weight:bold
    classDef green fill:#00CC00,color:white,font-weight:bold

    class FAIL_CHANNEL red
    class FUNDED blue
    class ACCEPT green

    [*] --> FUNDED: ! FUNDING_LOCKED\n-----------------------------\nfulfilled #colon;= false
    FUNDED --> CLOSE_CHANNEL: ? CLOSE_CHANNEL
    FUNDED --> FAIL_CHANNEL: (2)\n(TIMEOUT && ! ERROR) || \nTIMEOUT ||\n? ERROR
    FUNDED --> RECV_HTLC: ? UPDATE_ADD_HTLC
    FUNDED --> SENT_HTLC: ! UPDATE_ADD_HTLC
    SENT_HTLC --> MORE_HTLCS_WAIT
    SENT_HTLC --> FAIL_CHANNEL: ? UPDATE_FAIL_HTLC ||\n? UPDATE_FAIL_MALFORMED_HTLC
    RECV_HTLC --> MORE_HTLCS_WAIT
    MORE_HTLCS_WAIT --> SENT_HTLC: ! UPDATE_ADD_HTLC
    MORE_HTLCS_WAIT --> RECV_HTLC: ? UPDATE_ADD_HTLC
    RECV_HTLC --> FAIL_CHANNEL: ! UPDATE_FAIL_HTLC ||\n! UPDATE_FAIL_MALFORMED_HTLC
    MORE_HTLCS_WAIT --> FAIL_CHANNEL: (TIMEOUT && ! ERROR) || \nTIMEOUT ||\n? ERROR
    MORE_HTLCS_WAIT --> HTLC_FULFILL_WAIT: (4)\n? COMMITMENT_SIGNED &&\n! REVOKE_AND_ACK &&\n! COMMITMENT_SIGNED &&\n? REVOKE_AND_ACK
    MORE_HTLCS_WAIT --> HTLC_FULFILL_WAIT: (5)\n! COMMITMENT_SIGNED &&\n? REVOKE_AND_ACK &&\n? COMMITMENT_SIGNED &&\n! REVOKE_AND_ACK
    MORE_HTLCS_WAIT --> HTLC_FULFILL_WAIT: (10)\n! COMMITMENT_SIGNED &&\n? COMMITMENT_SIGNED &&\n! REVOKE_AND_ACK &&\n? REVOKE_AND_ACK
    MORE_HTLCS_WAIT --> HTLC_FULFILL_WAIT: (12)\n! COMMITMENT_SIGNED &&\n? COMMITMENT_SIGNED &&\n? REVOKE_AND_ACK &&\n! REVOKE_AND_ACK
    HTLC_FULFILL_WAIT --> FAIL_CHANNEL: (TIMEOUT && ! ERROR) || \nTIMEOUT ||\n? ERROR
    HTLC_FULFILL_WAIT --> HTLC_FULFILLED: ? UPDATE_FULFILL_HTLC ||\n! UPDATE_FULFILL_HTLC
    HTLC_FULFILLED --> HTLC_FULFILLED: ? UPDATE_FULFILL_HTLC ||\n! UPDATE_FULFILL_HTLC
    HTLC_FULFILLED --> MORE_HTLCS_WAIT: fulfilled #colon;= true
    HTLC_FULFILLED --> FAIL_CHANNEL: (TIMEOUT && ! ERROR) || \nTIMEOUT ||\n? ERROR
    HTLC_FULFILL_WAIT --> ACCEPT: fulfilled == true
```

`
